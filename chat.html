<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - ChatBloom</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; height: 100vh; margin: 0; display: flex; overflow: hidden; }
    .server-bar { width: 80px; background: linear-gradient(180deg,#ff9a9e,#fad0c4); display: flex; flex-direction: column; align-items: center; padding: 15px 0; gap: 15px; }
    .server-icon { width: 55px; height: 55px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #ff9a9e; cursor: pointer; transition: transform .2s, background .3s; text-decoration: none; }
    .server-icon:hover { transform: scale(1.1); background: #fff0f5; }
    .channel-bar { width: 250px; background: #fff; border-right: 2px solid #fbc2eb; display: flex; flex-direction: column; padding: 20px; }
    .channel-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; color: #ff7aa2; }
    .channel-item { padding: 8px 12px; border-radius: 8px; cursor: pointer; color: #555; transition: background .2s; }
    .channel-item:hover, .channel-item.active { background: #fbc2eb; color: #fff; }
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #fefefe; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
    .message { margin-bottom: 15px; }
    .message strong { color: #ff7aa2; }
    .chat-input { padding: 15px; border-top: 2px solid #fbc2eb; display: flex; gap: 10px; }
    .chat-input input { flex: 1; border-radius: 50px; border: 2px solid #fbc2eb; padding: 10px 15px; }
    .chat-input button { border-radius: 50px; padding: 10px 20px; border: none; background: linear-gradient(90deg,#ff9a9e,#fad0c4); color:white; font-weight:600; }
    .chat-input button:hover { opacity: .9; }
    .user-info { margin-top: auto; font-size:.9rem; color:#777; text-align:center; }
    .logout-btn, #settingsBtn { margin-top:10px; padding:5px 10px; border-radius:8px; background:#ff9a9e; color:white; border:none; cursor:pointer; width:90%; }
    .logout-btn:hover, #settingsBtn:hover { opacity:.85; }
  </style>
</head>
<body>
  <div class="server-bar">
    <div class="server-icon">
      <a href="announcement.html" class="server-icon">📢</a>
    </div>

    <a href="add-friends.html" class="server-icon" title="Add Friends">➕</a>
  </div>

  <div class="channel-bar">
    <div class="channel-title">Friends</div>
    <div id="friendsList" class="d-flex flex-column gap-1"></div>
    <div class="user-info">
      <div id="userInfo">Loading...</div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
      <button class="logout-btn" id="settingsBtn">Settings</button>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Account Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newDisplayName" class="form-label">Display Name</label>
            <input type="text" class="form-control" id="newDisplayName" placeholder="New display name">
            <button class="btn btn-primary mt-2" id="changeNameBtn">Change Name</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, addDoc, serverTimestamp, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAkUB8cH0kBTVf4jDmJvqe-ZiM0npDiaRU",
  authDomain: "chatbloom-70593.firebaseapp.com",
  projectId: "chatbloom-70593",
  storageBucket: "chatbloom-70593.firebasestorage.app",
  messagingSenderId: "761754714884",
  appId: "1:761754714884:web:343fb283e544628cc2c651",
  measurementId: "G-E30VD1GML1"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser, selectedFriendUid, selectedFriendName;

    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      currentUser = user;
      document.getElementById('userInfo').textContent = `Welcome, ${user.displayName || user.email}`;
      loadFriends();
    });

    document.getElementById('logoutBtn').addEventListener('click', async ()=> {
      await signOut(auth);
      window.location.href='login.html';
    });

    document.getElementById('settingsBtn').addEventListener('click', ()=> {
      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
    });

    // Settings functions
    import { updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

document.getElementById('changeNameBtn').addEventListener('click', async ()=>{
  const newName = document.getElementById('newDisplayName').value.trim();
  if(!newName) return alert('Enter a name');

  try {
    // 1️⃣ Update Firebase Auth profile
    await updateProfile(currentUser, { displayName: newName });

    // 2️⃣ Update Firestore users collection
    await updateDoc(doc(db, 'users', currentUser.uid), { displayName: newName });

    alert('Name updated successfully!');
    document.getElementById('userInfo').textContent = `Welcome, ${newName}`;
    
    // 3️⃣ Reload friends list to show updated name
    loadFriends();
  } catch(err){
    alert(err.message);
  }
});


    // Friends & Chat
    async function loadFriends(){
      const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
      if(!userDoc.exists()) return;
      const friends = userDoc.data().friends || [];
      const container = document.getElementById('friendsList');
      container.innerHTML='';
      for(let uid of friends){
        const fSnap = await getDoc(doc(db,'users',uid));
        const fName = fSnap.exists()? fSnap.data().displayName : uid;
        const div = document.createElement('div');
        div.className='channel-item';
        div.textContent=fName;
        div.onclick = ()=> selectFriend(uid,fName);
        container.appendChild(div);
      }
    }

    function selectFriend(uid,name){
      selectedFriendUid=uid;
      selectedFriendName=name;
      document.getElementById('chatMessages').innerHTML='';
      loadMessages();
    }

    async function loadMessages(){
      if(!selectedFriendUid) return;
      const chatId = [currentUser.uid, selectedFriendUid].sort().join('_');
      const q = query(collection(db,'chats',chatId,'messages'), orderBy('timestamp'));
      onSnapshot(q, snapshot => {
        const container = document.getElementById('chatMessages');
        container.innerHTML='';
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const div = document.createElement('div');
          div.className='message';
          const senderName = msg.sender===currentUser.uid ? 'You' : selectedFriendName;
          div.innerHTML=`<strong>${senderName}:</strong> ${msg.text}`;
          container.appendChild(div);
        });
        container.scrollTop=container.scrollHeight;
      });
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', e=>{
      if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }
    });

    async function sendMessage(){
      const text = document.getElementById('chatInput').value.trim();
      if(!text || !selectedFriendUid) return;
      const chatId = [currentUser.uid, selectedFriendUid].sort().join('_');
      await addDoc(collection(db,'chats',chatId,'messages'), {
        sender: currentUser.uid,
        text,
        timestamp: serverTimestamp()
      });
      document.getElementById('chatInput').value='';
    }
  </script>
</body>
</html>
